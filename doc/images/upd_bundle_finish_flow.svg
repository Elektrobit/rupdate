<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="797px" preserveAspectRatio="none" style="width:1169px;height:797px;" version="1.1" viewBox="0 0 1169 797" width="1169px" zoomAndPan="magnify"><defs><filter height="300%" id="fcmsazf5ywhyi" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#fcmsazf5ywhyi)" height="783.0988" style="stroke: #000000; stroke-width: 1.0;" width="1155.5" x="3" y="3"/><path d="M235,4 L235,15.0679 L225,25.0679 L3,25.0679 " fill="none" style="stroke: #000000; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="222" x="6" y="18.9659">uc finish of new software version</text><rect fill="#DDDDDD" height="735.7219" style="stroke: #A80036; stroke-width: 1.0;" width="756.5" x="9" y="33.0679"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="47" x="363.75" y="46.9649">System</text><rect fill="#DDDDDD" height="735.7219" style="stroke: #A80036; stroke-width: 1.0;" width="221" x="767.5" y="33.0679"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="59" x="848.5" y="46.9649">Userland</text><rect fill="#FFFFFF" filter="url(#fcmsazf5ywhyi)" height="543.5359" style="stroke: #000000; stroke-width: 2.0;" width="1034.5" x="107" y="214.2539"/><rect fill="#FFFFFF" filter="url(#fcmsazf5ywhyi)" height="353.0239" style="stroke: #000000; stroke-width: 2.0;" width="746" x="385.5" y="336.0779"/><rect fill="#FFFFFF" filter="url(#fcmsazf5ywhyi)" height="181.218" style="stroke: #000000; stroke-width: 2.0;" width="599" x="395.5" y="439.196"/><rect fill="#FFFFFF" height="48.6879" style="stroke: none; stroke-width: 1.0;" width="599" x="395.5" y="571.7261"/><rect fill="#FFFFFF" height="61.6879" style="stroke: none; stroke-width: 1.0;" width="746" x="385.5" y="627.414"/><rect fill="#FFFFFF" height="61.6879" style="stroke: none; stroke-width: 1.0;" width="1034.5" x="107" y="696.1019"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="54" x2="54" y1="119.8419" y2="774.7898"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="162" x2="162" y1="119.8419" y2="774.7898"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="436.5" x2="436.5" y1="119.8419" y2="774.7898"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="513.5" x2="513.5" y1="119.8419" y2="774.7898"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="689.5" x2="689.5" y1="119.8419" y2="774.7898"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="793.5" x2="793.5" y1="119.8419" y2="774.7898"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="933.5" x2="933.5" y1="119.8419" y2="774.7898"/><rect fill="#FEFECE" filter="url(#fcmsazf5ywhyi)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="79" x="13" y="81.7739"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="65" x="20" y="103.7399">hardware</text><rect fill="#FEFECE" filter="url(#fcmsazf5ywhyi)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="117" y="81.7739"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="124" y="103.7399">bootloader</text><rect fill="#FEFECE" filter="url(#fcmsazf5ywhyi)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="58" x="405.5" y="81.7739"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="44" x="412.5" y="103.7399">Kernel</text><rect fill="#FEFECE" filter="url(#fcmsazf5ywhyi)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="68" x="477.5" y="81.7739"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="484.5" y="103.7399">rupdate</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="617.5" y="115.7399">update environment</text><path d="M671.5,64.7739 C671.5,54.7739 689.5,54.7739 689.5,54.7739 C689.5,54.7739 707.5,54.7739 707.5,64.7739 L707.5,90.7739 C707.5,100.7739 689.5,100.7739 689.5,100.7739 C689.5,100.7739 671.5,100.7739 671.5,90.7739 L671.5,64.7739 " fill="#FEFECE" filter="url(#fcmsazf5ywhyi)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M671.5,64.7739 C671.5,74.7739 689.5,74.7739 689.5,74.7739 C689.5,74.7739 707.5,74.7739 707.5,64.7739 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FEFECE" filter="url(#fcmsazf5ywhyi)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="40" x="771.5" y="81.7739"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="26" x="778.5" y="103.7399">app</text><rect fill="#FEFECE" filter="url(#fcmsazf5ywhyi)" height="52.1358" style="stroke: #A80036; stroke-width: 1.5;" width="98" x="882.5" y="62.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="907" y="84.672">selftest</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="893.5" y="103.7399">&amp; migration</text><rect fill="#EEEEEE" filter="url(#fcmsazf5ywhyi)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1143.5" x="8" y="151.6949"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="1151.5" y1="151.6949" y2="151.6949"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="1151.5" y1="154.6949" y2="154.6949"/><rect fill="#EEEEEE" filter="url(#fcmsazf5ywhyi)" height="25.706" style="stroke: #000000; stroke-width: 2.0;" width="132" x="513.75" y="139.8419"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="519.75" y="157.7389">Start new version</text><polygon fill="#A80036" points="150.5,195.2539,160.5,199.2539,150.5,203.2539,154.5,199.2539" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="54.5" x2="156.5" y1="199.2539" y2="199.2539"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="61.5" y="193.4449">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="72.5" y="193.4449">pass control</text><path d="M107,214.2539 L170,214.2539 L170,223.2539 L160,233.2539 L107,233.2539 L107,214.2539 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="543.5359" style="stroke: #000000; stroke-width: 2.0;" width="1034.5" x="107" y="214.2539"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="122" y="229.1509">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="185" y="228.0128">[new version is able to boot]</text><polygon fill="#A80036" points="424.5,253.6659,434.5,257.6659,424.5,261.6659,428.5,257.6659" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="162.5" x2="430.5" y1="257.6659" y2="257.6659"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="169.5" y="251.8569">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="180.5" y="251.8569">pass control</text><polygon fill="#A80036" points="781.5,285.3719,791.5,289.3719,781.5,293.3719,785.5,289.3719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="787.5" y1="289.3719" y2="289.3719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="443.5" y="283.5629">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="454.5" y="283.5629">pass control</text><polygon fill="#A80036" points="524.5,317.0779,514.5,321.0779,524.5,325.0779,520.5,321.0779" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="518.5" x2="792.5" y1="321.0779" y2="321.0779"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="530.5" y="315.2689">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="541.5" y="315.2689">query update state</text><path d="M385.5,336.0779 L448.5,336.0779 L448.5,345.0779 L438.5,355.0779 L385.5,355.0779 L385.5,336.0779 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="353.0239" style="stroke: #000000; stroke-width: 2.0;" width="746" x="385.5" y="336.0779"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="400.5" y="350.975">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="94" x="463.5" y="349.8369">[state == testing]</text><polygon fill="#A80036" points="921.5,375.49,931.5,379.49,921.5,383.49,925.5,379.49" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793.5" x2="927.5" y1="379.49" y2="379.49"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="800.5" y="373.681">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="811.5" y="373.681">pass control</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="933.5" x2="975.5" y1="411.196" y2="411.196"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="975.5" x2="975.5" y1="411.196" y2="424.196"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="934.5" x2="975.5" y1="424.196" y2="424.196"/><polygon fill="#A80036" points="944.5,420.196,934.5,424.196,944.5,428.196,940.5,424.196" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="940.5" y="405.387">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="951.5" y="405.387">do selftest and migrate data</text><path d="M395.5,439.196 L458.5,439.196 L458.5,448.196 L448.5,458.196 L395.5,458.196 L395.5,439.196 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="181.218" style="stroke: #000000; stroke-width: 2.0;" width="599" x="395.5" y="439.196"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="410.5" y="454.093">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="473.5" y="452.9549">[selftest pass]</text><polygon fill="#A80036" points="524.5,478.608,514.5,482.608,524.5,486.608,520.5,482.608" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="518.5" x2="932.5" y1="482.608" y2="482.608"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="530.5" y="476.799">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="541.5" y="476.799">finish the update</text><polygon fill="#A80036" points="677.5,528.0201,687.5,532.0201,677.5,536.0201,681.5,532.0201" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="513.5" x2="683.5" y1="532.0201" y2="532.0201"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="520.5" y="517.3581">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="531.5" y="508.505">make setting persistent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="531.5" y="526.2111">set remaining_tries=-1</text><polygon fill="#A80036" points="804.5,559.7261,794.5,563.7261,804.5,567.7261,800.5,563.7261" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="798.5" x2="932.5" y1="563.7261" y2="563.7261"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="810.5" y="557.9171">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="821.5" y="557.9171">normal operation</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="395.5" x2="994.5" y1="572.7261" y2="572.7261"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="69" x="400.5" y="584.485">[selftest fail]</text><polygon fill="#A80036" points="447.5,608.414,437.5,612.414,447.5,616.414,443.5,612.414" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="441.5" x2="932.5" y1="612.414" y2="612.414"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="453.5" y="606.605">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="471.5" y="606.605">reboot to revert the new version and fallback to prev.</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="385.5" x2="1131.5" y1="628.414" y2="628.414"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="390.5" y="640.1729">[other state]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="793.5" x2="835.5" y1="668.1019" y2="668.1019"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="835.5" x2="835.5" y1="668.1019" y2="681.1019"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="794.5" x2="835.5" y1="681.1019" y2="681.1019"/><polygon fill="#A80036" points="804.5,677.1019,794.5,681.1019,804.5,685.1019,800.5,681.1019" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="800.5" y="662.2929">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="818.5" y="662.2929">normal operation</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="107" x2="1141.5" y1="697.1019" y2="697.1019"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="112" y="708.8608">[new version is unable to boot]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="162.5" x2="204.5" y1="736.7898" y2="736.7898"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="204.5" x2="204.5" y1="736.7898" y2="749.7898"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="163.5" x2="204.5" y1="749.7898" y2="749.7898"/><polygon fill="#A80036" points="173.5,745.7898,163.5,749.7898,173.5,753.7898,169.5,749.7898" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="169.5" y="730.9808">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="187.5" y="730.9808">reboot and fallback if tries are exhausted</text><!--MD5=[b32523d2dc04badc9187810f1ffe5c6e]
@startuml upd_bundle_finish_flow

hide footbox
autonumber


box "System"
        participant "hardware" as hw
        participant "bootloader" as bootldr
        database "update environment" as updenv
        participant "Kernel" as os
        participant "rupdate" as updtool
        database "update environment" as updenv
end box

box "Userland"
        participant "app" as capp
        participant "selftest\n & migration" as selftest
end box

mainframe uc finish of new software version


== Start new version ==

hw -> bootldr : pass control

alt new version is able to boot

  bootldr -> os : pass control
  os -> capp : pass control
  capp -> updtool : query update state

  alt state == testing

  capp -> selftest : pass control
  selftest -> selftest: do selftest and migrate data

  alt selftest pass

    selftest -> updtool : finish the update
    updtool -> updenv : make setting persistent\nset remaining_tries=-1
    selftest -> capp : normal operation

  else selftest fail

    selftest -> os : reboot to revert the new version and fallback to prev.

  end

  else other state
    capp -> capp: normal operation
  end 

else new version is unable to boot

  bootldr -> bootldr: reboot and fallback if tries are exhausted

end


@enduml

PlantUML version 1.2020.02(Sun Mar 01 11:22:07 CET 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.22+7-post-Ubuntu-0ubuntu222.04.1
Operating System: Linux
Default Encoding: UTF-8
Language: de
Country: DE
--></g></svg>